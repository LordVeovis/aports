# Contributor: Veovis <veovis@kveer.fr>
# Maintainer: Veovis <veovis@kveer.fr>
pkgname=gitaly
pkgver=0.52.1
pkgrel=2
pkgdesc="Gitlab Gitaly"
url="https://gitlab.com/gitlab-org/gitaly"
arch="all"
license="MIT"
depends="ruby2.3 ruby2.3-rdoc icu-libs zlib"
#depends_dev="boost-dev gobject-introspection-dev libevent-dev openssl-dev zlib-dev"
makedepends="$depends_dev go ruby2.3 ruby2.3-dev icu-dev zlib-dev cmake"
install=""
subpackages="$pkgname-dbg"
source="https://gitlab.com/gitlab-org/gitaly/repository/v$pkgver/archive.tar.bz2"
giturl="https://gitlab.com/gitlab-org/gitaly.git"
options="!check"

builddir="$srcdir"/$pkgname-v$pkgver-217f449ae1e017636423d9b5be5560e5ed068753

build() {
	cd "$builddir"

	export PATH=$PATH:$HOME/.gem/ruby/2.3.0/bin
	gem install bundler --user-install --no-ri --no-rdoc --version 1.15.4 || return 1
	BUNDLE_CLEAN=1 make build || return 1
}

package() {
	cd "$builddir"

	make install PREFIX="$pkgdir/usr" || return 1

	sed -i -e 's!^(bin_dir = ).*$!\1 "/usr/bin"!' config.toml.example
	sed -i -e 's!^(dir = ).*$!\1 "/usr/lib/gitlab/gitaly-ruby"!' config.toml.example
	sed -i -e 's!^# \(bin_path = .*\)!\1"!' config.toml.example

	find "$builddir"/ruby/vendor/bundle/ruby/ -type d -name ext -maxdepth 4 -exec rm -R {} +
	rm -R "$builddir"/ruby/vendor/bundle/ruby/2.3.0/cache
	mkdir -p "$pkgdir"/usr/lib/ruby
	mv "$builddir"/ruby/vendor/bundle/ruby/ "$pkgdir"/usr/lib/ruby/gems/

	install -d "$pkgdir"/etc/gitlab/gitaly/ || return 1
	install config.toml.example "$pkgdir"/etc/gitlab/gitaly/ || return 1

	install -d "$pkgdir"/usr/lib/gitlab || return 1
	cp -R ruby "$pkgdir"/usr/lib/gitlab/gitaly-ruby || return 1
	chown -R root:root "$pkgdir"/usr/lib/gitlab/gitaly-ruby || return 1
	chmod -R u=rwX,go=rX "$pkgdir"/usr/lib/gitlab/gitaly-ruby || return 1
}

sha512sums="29b1aa7c129255d99ea0830f1e6eb5078d279267e63090788fa2e6552fa19360856c0be375b3b611c94ff6dd96538b874d4d8365ade99701adb42b1e495c7073  archive.tar.bz2"
